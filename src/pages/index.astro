---
import Layout from "@/layouts/layout.astro";
import type { Person, WithContext } from "schema-dts"

import PageHero from "@/sections/hero.astro"
import Agitation from "@/sections/agitation.astro"
import Philosophy from "@/sections/philosophy.astro"
import Authority from "@/sections/authority.astro"

import { getSinglePage } from '@/lib/content-parser.astro';
import { sortByDate } from '@/lib/utils/sort';
import BlogPost from '@/components/blog-post.astro';
import Link from '@/components/link.astro';


const metaData = {
    title: "Julian Koehn",
    summary: "GRC Engineering & Asset-First Security. Building trust through deterministic systems.",
    get description() {
        return `${this.title} - ${this.summary}`
    },
}

const jsonLd: WithContext<Person> = {
    "@context": "https://schema.org",
    "@type": "Person",
    name: "Julian Koehn",
    alternateName: "Julian",
    description: metaData.summary,
    email: "me@julian.pro"
}

if (Astro.site) {
  jsonLd["@id"] = `${Astro.site}#identity`
  jsonLd.url = Astro.site.toString()
}

const posts = await getSinglePage("blog")
const sortedPosts = sortByDate(posts)
const currentPosts = sortedPosts.slice(0, 3);
---
<Layout>
    <!-- 1. Hero: Asset-First Security -->
    <PageHero />

    <!-- 2. The Agitation: Compliance Theater -->
    <Agitation />

    <!-- 3. The Shift: Philosophy / 3 Pillars -->
    <Philosophy />

    <!-- 4. The Authority: Builder. CTO. Realist. -->
    <Authority />

    <!-- 5. Engineering Logs: Content -->
    <section class="w-full px-5vw relative py-32 border-t border-white/5">
        <div class="mx-auto max-w-8xl">
            <div class="mb-16">
                 <span class="font-sans font-semibold text-secondary text-sm uppercase tracking-widest mb-4 block">
                    Deep Dives
                </span>
                <h2 class="font-serif font-bold text-white text-4xl lg:text-6xl tracking-tight">
                    Field Notes &<br/>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-secondary to-white">Engineering Logs.</span>
                </h2>
                <p class="mt-6 text-lg text-gray-400 font-sans max-w-2xl">
                    Thoughts on dismantling the bureaucracy of security.
                </p>
            </div>

            <div
            class="relative grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"
            >
            {
                currentPosts.map((post) => (
                <div class="flex flex-col group h-full">
                    <BlogPost url={`/blog/${post.slug}`} title={post.data.title} date={post.data.date} image={post.data.image}
                        description={post.data.description}
                    />
                </div>
                ))
            }
            </div>

            <div class="mt-12">
                <Link href="/blog">
                    View All Logs â†’
                </Link>
            </div>
        </div>
    </section>

    <!-- Footer is included via Layout -->
</Layout>